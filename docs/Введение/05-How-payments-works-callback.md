# Как работает платёж - Callback API

Я бы хотел начать с небольшого предупреждения, для любителей пропустить важную инфу.

<!-- theme: warning -->

> ### Кхм...
>
> Если ты не читал [Как работает платёж - начало](04-How-payments-works.md), то тебе его надо прочитать, перед тем как понять что происходит здесь

### Продолжим

Раз ты решил узнать о успешном платеже, используя Callback API, то значит у тебя однозначно есть какой-либо сервер, который может принимать запросы.

Как это работает:

- Пишешь в URL события в настройках приложения URL handler'a своего сервера (например `test.drom.one/handler`)
- Сервер Dromon'a при успешной оплате отправляет POST запрос на твой сервер с `uid`, `text`, и заголовком `Authorization`.

### Запрос

Запрос является самым обычным POST запросом. В заголовке (headers) запроса присутствуют:

- `Content-Type: application/json` (то есть сервер Dromon отправляет ответ в json формате)
- `Authorization: Bearer {token}` (token - хэшированый в md5 `app_secret`, чтобы можно было проверить запрос на подлинность)

Тело запроса - небольшой json, в котором есть всё необходимое, чтобы знать что за платёж был совершён

<!--
type: tab
title: Схема
-->

```json json_schema
{
  "title": "Payment",
  "type": "object",
  "properties": {
    "uid": {
      "type": "string"
    },
    "text": {
      "type": "string"
    },
    "sum": {
      "type": "integer"
    }
  }
}
```

<!--
type: tab
title: Пример
-->

```json
{
  "uid": "88273-D",
  "text": "Заказ 88273-D",
  "sum": 8
}
```

<!-- type: tab-end -->

### Сервер

Действия, которые ты делаешь:

Ну вообще для начала ты слушаешь URL Handler'a (например `test.drom.one/handler`). Это может быть также php страница (например `test.drom.one/handler.php`).

Ну а дальше всё по схеме:

1. Пользователь оформляет заказ - генерируем `uid`, ссылку с участием `text`, `uid`, `sign`, суммы.
2. Записываем, что заказ X, с id `uid` принадлежит заказавшему.
3. Отправляем ссылку пользователю.
4. Пользователь оплачивает заказ.
5. Dromon сервер отправляет POST запрос на твой сервер.
6. При получении POST запроса на handler'e сверяем, что полученный заголовок `Authorization` совпадает с `Bearer {token}`, где `{token}` - хэшированый в md5 `app_secret`
7. Ищем в базе заказавшего по `uid`
8. **Готово!**

Вы можете отправить какое-либо уведомление пользователю, что заказ был успешно оплачен, а также направить сообщение работникам о необходимости собрать заказ. 
Или дать никнейм доставщикам, чтобы они уточненили место/время доставки
